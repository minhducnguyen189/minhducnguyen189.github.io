<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- bootstrap library and JS, Jquery -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Spring Security: SQL Injection | StepByStep</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Spring Security: SQL Injection" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="WHAT IS THE SQL INJECTION? SQL injection is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. It generally allows an attacker to view data that they are not normally able to retrieve. This might include data belonging to other users, or any other data that the application itself is able to access. In many cases, an attacker can modify or delete this data, causing persistent changes to the application’s content or behavior. More information An injection attack can happen when we execute dynamic code based on user input. Dynamic code is code created on runtime based on user input, such as SQL statement with parameters. It’s like injecting a dangerous piece of string into input string, hence the name injection. Application might not know which string is dangerous, so the application will execute all the string, including dangerous one. For example: we expect that the SQL will query for us the name of people following the email. If application is vulnerable, sql injection can inject this dangerous code. --Expected SELECT name FROM people WHERE email = ... --Injected DROP TABLE users --So application will executed both SELECT name FROM people WHERE email =... DROP TABLE users SQL injection took place on user input, on API it can be many ways like request parameters, path variables or request body. Api code is vulnerable for sql injection in database access part . If the code build dynamic statement by joining strings from user input then it will open the security hole. We usually misunderstand that using framework is safe from SQL injection. For example, you are using Spring JPA or Hibernate, so you think that you are safe from SQL Injection. The answer is no, the framework helps us avoid create hand codes SQL statements but framework doesn’t prevent us to write vulnerable code. If you still use string join to build sql statements, framework will not validate it against SQL injection. EXAMPLE WITH JDBC CORE So, let’s take an example so you can understand it deeper. Let’s create a gradle string boot service with apis receive a request and execute a vulnerable sql into the database. DEPENDENCIES If you don’t know how to create a spring boot service with gradlew, you can view this post. We will use postgressql, So if you don’t know how to install this DB, you can view this post dependencies { compileOnly &#39;org.projectlombok:lombok:1.18.20&#39; annotationProcessor &#39;org.projectlombok:lombok:1.18.20&#39; implementation &#39;org.springframework.boot:spring-boot-starter-data-jdbc&#39; implementation &#39;org.springdoc:springdoc-openapi-ui:1.5.10&#39; implementation &#39;org.springframework.boot:spring-boot-starter-web&#39; testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39; implementation &#39;org.postgresql:postgresql:42.2.23&#39; } STRUCTURE Then you need to create some package as the image below API Let’s create an api class JdbcCustomerCrudApi which will contain an api as below package com.example.security.api.server.sqlinjection; import com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest; import com.example.security.entity.JdbcCustomer; import com.example.security.repository.JdbcCustomerDangerRepository; import com.fasterxml.jackson.databind.ObjectWriter; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.validation.constraints.Pattern; import java.util.List; import java.util.Objects; @RestController @RequestMapping(&quot;/api/sqlinjection/danger/v1&quot;) @Validated public class JdbcCustomerCrudApi { @Autowired private JdbcCustomerDangerRepository repository; @PostMapping(value = &quot;/customers&quot;) public void createCustomer(@RequestBody(required = true) JdbcCustomer newCustomer) { repository.createCustomer(newCustomer); } } ENTITY You need to create an entity object to receive data from request map it into sql statement. package com.example.security.entity; import lombok.AllArgsConstructor; import lombok.Getter; import lombok.NoArgsConstructor; import lombok.Setter; import org.springframework.data.annotation.Id; import java.time.LocalDate; @Getter @Setter @NoArgsConstructor @AllArgsConstructor public class JdbcCustomer { @Id private int customerId; private String fullName; private String email; private LocalDate birthDate; private String gender; } REPOSITORY So now, we will create a repository class which will contain the vulnerable sql statement. package com.example.security.repository; import com.example.security.entity.JdbcCustomer; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jdbc.core.BeanPropertyRowMapper; import org.springframework.jdbc.core.JdbcTemplate; import org.springframework.stereotype.Repository; import java.sql.ResultSet; import java.sql.SQLException; import java.util.List; import java.util.Optional; @Repository public class JdbcCustomerDangerRepository { @Autowired private JdbcTemplate jdbcTemplate; private JdbcCustomer mapToCustomer(ResultSet rs, long rowNum) throws SQLException { JdbcCustomer customer = new JdbcCustomer(); Optional.ofNullable(rs.getDate(&quot;birth_date&quot;)).ifPresent(b -&gt; customer.setBirthDate(b.toLocalDate())); customer.setCustomerId(rs.getInt(&quot;customer_id&quot;)); customer.setEmail(rs.getString(&quot;email&quot;)); customer.setFullName(rs.getString(&quot;full_name&quot;)); customer.setGender(rs.getString(&quot;gender&quot;)); return customer; } public void createCustomer(JdbcCustomer newCustomer) { String sql = &quot;INSERT INTO jdbc_customer(full_name, email, birth_date, gender) VALUES (&quot; + &quot;&#39;&quot; + newCustomer.getFullName() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getEmail() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getBirthDate() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getGender() + &quot;&#39;, &quot; + &quot;&#39;)&quot;; jdbcTemplate.execute(sql); } } SAMPLE DATABASE TABLES So we need to create some sample database as the image below Below is the sql scripts for these tables DROP TABLE IF EXISTS jdbc_customer; CREATE TABLE jdbc_customer (customer_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, full_name VARCHAR(50), email VARCHAR(50) NOT NULL UNIQUE, birth_date DATE, gender VARCHAR(50)); INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Maggee Donald&#39;, &#39;mdonald0@marriott.com&#39;, &#39;1987-06-13&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Arni Sturch&#39;, &#39;asturch1@bbb.org&#39;, &#39;1981-05-02&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Abbot Angel&#39;, &#39;aangel2@ihg.com&#39;, &#39;1984-12-23&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Georgeta Drackford&#39;, &#39;gdrackford3@nature.com&#39;, &#39;1993-11-02&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Marin Pollendine&#39;, &#39;mpollendine4@reddit.com&#39;, &#39;1999-10-21&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Lloyd Garber&#39;, &#39;lgarber5@wsj.com&#39;, &#39;1991-08-28&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Savina Manwaring&#39;, &#39;smanwaring6@sfgate.com&#39;, &#39;1996-01-03&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Daniel Hansard&#39;, &#39;dhansard7@rediff.com&#39;, &#39;1986-09-18&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Patricia Titherington&#39;, &#39;ptitherington8@ehow.com&#39;, &#39;1994-07-12&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Meta Boleyn&#39;, &#39;mboleyn9@ox.ac.uk&#39;, &#39;1982-05-20&#39;, &#39;F&#39;) ; --- DROP TABLE IF EXISTS jdbc_merchant; CREATE TABLE jdbc_merchant (merchant_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, merchant_name VARCHAR(50), email VARCHAR(50), description text); INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Heathcote Inc&#39;, &#39;rgilkes0@e-recht24.de&#39;, &#39;Maecenas tristique, est et tempus semper, est quam pharetra magna, ac consequat metus sapien ut nunc. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Mauris viverra diam vitae quam. Suspendisse potenti.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Volkman, Roberts and Dietrich&#39;, &#39;ebenstead1@auda.org.au&#39;, &#39;Nullam porttitor lacus at turpis. Donec posuere metus vitae ipsum. Aliquam non mauris.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Moore LLC&#39;, &#39;mtillman2@house.gov&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Purdy and Sons&#39;, &#39;jhambelton3@wikipedia.org&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Kuhic-Parisian&#39;, &#39;dmccreery4@wix.com&#39;, &#39;Curabitur at ipsum ac tellus semper interdum. Mauris ullamcorper purus sit amet nulla. Quisque arcu libero, rutrum ac, lobortis vel, dapibus at, diam.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Greenfelder-Emard&#39;, &#39;eclara5@webeden.co.uk&#39;, &#39;Duis aliquam convallis nunc. Proin at turpis a pede posuere nonummy. Integer non velit.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Armstrong and Sons&#39;, &#39;mhartle6@phoca.cz&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Goyette-Pollich&#39;, &#39;vblowin7@jiathis.com&#39;, &#39;In quis justo. Maecenas rhoncus aliquam lacus. Morbi quis tortor id nulla ultrices aliquet.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Yundt Group&#39;, &#39;larnli8@pen.io&#39;, &#39;Morbi porttitor lorem id ligula. Suspendisse ornare consequat lectus. In est risus, auctor sed, tristique in, tempus sit amet, sem.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Wintheiser-Cummerata&#39;, &#39;cbartzen9@archive.org&#39;, NULL) ; --- CREATE OR REPLACE PROCEDURE public.update_jdbc_customer(existing_customer_id bigint, new_full_name CHARACTER varying) LANGUAGE &#39;plpgsql&#39; AS $BODY$ declare dynamic_sql varchar(1000); begin dynamic_sql = &#39;update jdbc_customer set full_name = &#39;&#39;&#39; || new_full_name || &#39;&#39;&#39; where customer_id = &#39; || existing_customer_id; execute dynamic_sql; end $BODY$; DROP TABLE IF EXISTS jpa_customer; CREATE TABLE jpa_customer (customer_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, full_name VARCHAR(50), email VARCHAR(50) NOT NULL UNIQUE, birth_date DATE, gender VARCHAR(50)); INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Maggee Donald&#39;, &#39;mdonald0@marriott.com&#39;, &#39;1987-06-13&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Arni Sturch&#39;, &#39;asturch1@bbb.org&#39;, &#39;1981-05-02&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Abbot Angel&#39;, &#39;aangel2@ihg.com&#39;, &#39;1984-12-23&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Georgeta Drackford&#39;, &#39;gdrackford3@nature.com&#39;, &#39;1993-11-02&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Marin Pollendine&#39;, &#39;mpollendine4@reddit.com&#39;, &#39;1999-10-21&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Lloyd Garber&#39;, &#39;lgarber5@wsj.com&#39;, &#39;1991-08-28&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Savina Manwaring&#39;, &#39;smanwaring6@sfgate.com&#39;, &#39;1996-01-03&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Daniel Hansard&#39;, &#39;dhansard7@rediff.com&#39;, &#39;1986-09-18&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Patricia Titherington&#39;, &#39;ptitherington8@ehow.com&#39;, &#39;1994-07-12&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Meta Boleyn&#39;, &#39;mboleyn9@ox.ac.uk&#39;, &#39;1982-05-20&#39;, &#39;F&#39;) ; DROP TABLE IF EXISTS xss_article CASCADE; CREATE TABLE xss_article (article_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, article text NOT NULL); DROP TABLE IF EXISTS basic_auth_user; CREATE TABLE basic_auth_user (user_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, username VARCHAR(150) NOT NULL UNIQUE, password_hash VARCHAR(100) NOT NULL, salt VARCHAR(16) NOT NULL UNIQUE, display_name VARCHAR(50)); INSERT INTO basic_auth_user (user_id, username, password_hash, salt, display_name) VALUES (9999, &#39;b47ae31867bf002df6ffde0a5e1f8bd4c7c371608121cc5edcaf52986d52e8e8&#39;, &#39;$2y$05$b03MQkjNRzjLKyu3R0PEaOW39lOQrrCF5Z1MkM78h6U4ysXQOqpe.&#39;, &#39;wnNJiOOYM3L9OdFq&#39;, &#39;Administrator&#39;) ; INSERT INTO basic_auth_user (user_id, username, password_hash, salt, display_name) VALUES (9998, &#39;f9c34cef4027cd1e547a9ea5a27152e3f24ab18f78baa6e036b67cc43bb44f26&#39;, &#39;$2y$05$RjfNaknMQ1DuRTL1UTfOSOxt9Yze.itnnYY6sbKzSNvPodZ5VSQ96&#39;, &#39;NXOrjNKqpMSwYXPQ&#39;, &#39;Elsa of Arendelle&#39;) ; DROP TABLE IF EXISTS basic_acl_uri; CREATE TABLE basic_acl_uri (uri_id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, METHOD VARCHAR(100) NOT NULL, uri VARCHAR(300) NOT NULL); DROP TABLE IF EXISTS basic_acl_user_uri_ref; CREATE TABLE basic_acl_user_uri_ref (user_id INTEGER, uri_id INTEGER); INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9981, &#39;GET&#39;, &#39;/api/acl/v\d{1,3}/one&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9982, &#39;DELETE&#39;, &#39;/api/acl/v\d{1,3}/one&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9983, &#39;POST&#39;, &#39;/api/acl/v\d{1,3}/anypath/.*&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9984, &#39;GET&#39;, &#39;/api/acl/v\d{1,3}/anypath/.*&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9985, &#39;PUT&#39;, &#39;/api/acl/v\d{1,3}/.*/three&#39;) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9982) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9983) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9984) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9985) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9981) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9982) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9985) ; DROP TABLE IF EXISTS basic_apikey; CREATE TABLE basic_apikey(apikey_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, user_id INT, apikey VARCHAR(64) NOT NULL UNIQUE, expired_at TIMESTAMP WITHOUT TIME ZONE); INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9999, &#39;adminApiKey001&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9999, &#39;adminApiKey002&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9998, &#39;elsaApiKey101&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9998, &#39;elsaApiKey102&#39;, now() + INTERVAL &#39;2 year&#39;) ; TESTING Now, let’s start your service and execute api with the payload as below { &quot;fullName&quot;: &quot;Peter Parker&quot;, &quot;email&quot;: &quot;peter.parker1@marvel.com&quot;, &quot;birthDate&quot;: &quot;2000-12-31&quot;, &quot;gender&quot;: &quot;M&#39;); DROP table jdbc_merchant --&quot; } As you can see in the gender field we will inject the SQL script to delete the table jdbc_merchant. So let’s execute the api with this payload Then you can go to DB to check tables and you will see the table jdbc_merchant has been deleted. EXAMPLE WITH JDBC SPRING FRAMEWORK So if you are using JDBC of Spring framework to create the repository, so it is also not safe with SQL injection. We will use the example above and add some implementations as below STRUCTURE REPOSITORY So let’s add more a repository interface JdbcCustomerCrudRepository.java in repository package as below package com.example.security.repository; import com.example.security.entity.JdbcCustomer; import org.springframework.data.jdbc.repository.query.Query; import org.springframework.data.repository.CrudRepository; import org.springframework.data.repository.query.Param; import org.springframework.stereotype.Repository; import java.util.List; @Repository public interface JdbcCustomerCrudRepository extends CrudRepository&lt;JdbcCustomer, Integer&gt; { List&lt;JdbcCustomer&gt; findByEmail(String email); List&lt;JdbcCustomer&gt; findByGender(String gender); //this is the custom query that will call to a function in DB to update customer @Query(&quot;CALL update_jdbc_customer(:customerId, :newFullName)&quot;) void updateCustomerFullName(@Param(&quot;customerId&quot;) int customerId, @Param(&quot;newFullName&quot;) String newFullName); } API Now, we create another rest api class as below package com.example.security.api.server.sqlinjection; import com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest; import com.example.security.entity.JdbcCustomer; import com.example.security.repository.JdbcCustomerCrudRepository; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.validation.Valid; import javax.validation.constraints.Pattern; import java.util.List; @RestController @RequestMapping(&quot;/api/sqlinjection/crud/v1&quot;) @Validated public class JdbcCustomerCrudApi { @Autowired private JdbcCustomerCrudRepository repository; @GetMapping(value = &quot;/customer/{email}&quot;) public JdbcCustomer findCustomerByEmail(@PathVariable(required = true, name = &quot;email&quot;) String email) { List&lt;JdbcCustomer&gt; queryResult = repository.findByEmail(email); if (queryResult != null &amp;&amp; !queryResult.isEmpty()) { return queryResult.get(0); } return null; } @GetMapping(value = &quot;/customer&quot;) public List&lt;JdbcCustomer&gt; findCustomersByGender( @Pattern(regexp = &quot;^[MF]$&quot;, message = &quot;Invalid gender&quot;) @RequestParam(required = true, name = &quot;genderCode&quot;) String genderCode) { return repository.findByGender(genderCode); } @PostMapping(value = &quot;/customer&quot;) public void createCustomer(@RequestBody(required = true) @Valid JdbcCustomer newCustomer) { repository.save(newCustomer); } @PatchMapping(value = &quot;/customer/{customerId}&quot;) public void updateCustomerFullName(@PathVariable(required = true, name = &quot;customerId&quot;) int customerId, @RequestBody(required = true) JdbcCustomerPatchRequest request) { repository.updateCustomerFullName(customerId, request.getNewFullName()); } } TESTING Now, let’s start your service and execute api with the payload as below for api creating customer { &quot;fullName&quot;: &quot;Peter Parker&quot;, &quot;email&quot;: &quot;peter.parker1@marvel.com&quot;, &quot;birthDate&quot;: &quot;2000-12-31&quot;, &quot;gender&quot;: &quot;M&#39;); DROP table jdbc_merchant --&quot; } As you can see in the gender field we will inject the SQL script to delete the table jdbc_merchant. So let’s execute the api with this payload Then you can go to DB to check tables and you will see the table jdbc_merchant has not been deleted. why does this happen?. So for the first example we use the concatenated string to build the SQL statement. Let’s see the example below, the input at email or role can be a string variable or an injected SQL script. SELECT * FROM mytable WHERE email = ? AND role = ? -- with vulnerable variable inputs, the sql will be looked like as below SELECT * FROM mytable WHERE email = superman@jla.com AND role = HERO; drop table users When we use the Jdbc Spring Framework, It will help us to build the prepared statement, the vulnerable input will be put into &#39;&#39; as a string value. So jdbc_merchant will not be deleted. -- with vulnerable variable inputs, they will be put into &#39;&#39; as a string value SELECT * FROM mytable WHERE email = &#39;superman@jla.com&#39; AND role = &#39;HERO; drop table users&#39; -- this is the query that jdbc spring generated. -- you can see, it&#39;s safe from injected SQL. INSERT INTO public.jdbc_customer (customer_id, full_name, email, birth_date, gender) VALUES(11, &#39;Peter Parker&#39;, &#39;peter.parker@marvel.com&#39;, &#39;2000-12-31&#39;, &#39;M&#39;&#39;); DROP table jdbc_merchant --&#39;); So for now, let’s execuste the update customer api which is vulnerable by custom query, this query will call to a store procedure to update the table. After the api is executed, then you can see we received 500 internal server error { &quot;newFullName&quot;: &quot;Peter Parker&#39;; drop table jdbc_merchant --&quot; } Now, let’s check the DB again, then you can see the table jdbc_merchant has been deleted, when the procedure is executed to update customer fullname." />
<meta property="og:description" content="WHAT IS THE SQL INJECTION? SQL injection is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. It generally allows an attacker to view data that they are not normally able to retrieve. This might include data belonging to other users, or any other data that the application itself is able to access. In many cases, an attacker can modify or delete this data, causing persistent changes to the application’s content or behavior. More information An injection attack can happen when we execute dynamic code based on user input. Dynamic code is code created on runtime based on user input, such as SQL statement with parameters. It’s like injecting a dangerous piece of string into input string, hence the name injection. Application might not know which string is dangerous, so the application will execute all the string, including dangerous one. For example: we expect that the SQL will query for us the name of people following the email. If application is vulnerable, sql injection can inject this dangerous code. --Expected SELECT name FROM people WHERE email = ... --Injected DROP TABLE users --So application will executed both SELECT name FROM people WHERE email =... DROP TABLE users SQL injection took place on user input, on API it can be many ways like request parameters, path variables or request body. Api code is vulnerable for sql injection in database access part . If the code build dynamic statement by joining strings from user input then it will open the security hole. We usually misunderstand that using framework is safe from SQL injection. For example, you are using Spring JPA or Hibernate, so you think that you are safe from SQL Injection. The answer is no, the framework helps us avoid create hand codes SQL statements but framework doesn’t prevent us to write vulnerable code. If you still use string join to build sql statements, framework will not validate it against SQL injection. EXAMPLE WITH JDBC CORE So, let’s take an example so you can understand it deeper. Let’s create a gradle string boot service with apis receive a request and execute a vulnerable sql into the database. DEPENDENCIES If you don’t know how to create a spring boot service with gradlew, you can view this post. We will use postgressql, So if you don’t know how to install this DB, you can view this post dependencies { compileOnly &#39;org.projectlombok:lombok:1.18.20&#39; annotationProcessor &#39;org.projectlombok:lombok:1.18.20&#39; implementation &#39;org.springframework.boot:spring-boot-starter-data-jdbc&#39; implementation &#39;org.springdoc:springdoc-openapi-ui:1.5.10&#39; implementation &#39;org.springframework.boot:spring-boot-starter-web&#39; testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39; implementation &#39;org.postgresql:postgresql:42.2.23&#39; } STRUCTURE Then you need to create some package as the image below API Let’s create an api class JdbcCustomerCrudApi which will contain an api as below package com.example.security.api.server.sqlinjection; import com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest; import com.example.security.entity.JdbcCustomer; import com.example.security.repository.JdbcCustomerDangerRepository; import com.fasterxml.jackson.databind.ObjectWriter; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.validation.constraints.Pattern; import java.util.List; import java.util.Objects; @RestController @RequestMapping(&quot;/api/sqlinjection/danger/v1&quot;) @Validated public class JdbcCustomerCrudApi { @Autowired private JdbcCustomerDangerRepository repository; @PostMapping(value = &quot;/customers&quot;) public void createCustomer(@RequestBody(required = true) JdbcCustomer newCustomer) { repository.createCustomer(newCustomer); } } ENTITY You need to create an entity object to receive data from request map it into sql statement. package com.example.security.entity; import lombok.AllArgsConstructor; import lombok.Getter; import lombok.NoArgsConstructor; import lombok.Setter; import org.springframework.data.annotation.Id; import java.time.LocalDate; @Getter @Setter @NoArgsConstructor @AllArgsConstructor public class JdbcCustomer { @Id private int customerId; private String fullName; private String email; private LocalDate birthDate; private String gender; } REPOSITORY So now, we will create a repository class which will contain the vulnerable sql statement. package com.example.security.repository; import com.example.security.entity.JdbcCustomer; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jdbc.core.BeanPropertyRowMapper; import org.springframework.jdbc.core.JdbcTemplate; import org.springframework.stereotype.Repository; import java.sql.ResultSet; import java.sql.SQLException; import java.util.List; import java.util.Optional; @Repository public class JdbcCustomerDangerRepository { @Autowired private JdbcTemplate jdbcTemplate; private JdbcCustomer mapToCustomer(ResultSet rs, long rowNum) throws SQLException { JdbcCustomer customer = new JdbcCustomer(); Optional.ofNullable(rs.getDate(&quot;birth_date&quot;)).ifPresent(b -&gt; customer.setBirthDate(b.toLocalDate())); customer.setCustomerId(rs.getInt(&quot;customer_id&quot;)); customer.setEmail(rs.getString(&quot;email&quot;)); customer.setFullName(rs.getString(&quot;full_name&quot;)); customer.setGender(rs.getString(&quot;gender&quot;)); return customer; } public void createCustomer(JdbcCustomer newCustomer) { String sql = &quot;INSERT INTO jdbc_customer(full_name, email, birth_date, gender) VALUES (&quot; + &quot;&#39;&quot; + newCustomer.getFullName() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getEmail() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getBirthDate() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getGender() + &quot;&#39;, &quot; + &quot;&#39;)&quot;; jdbcTemplate.execute(sql); } } SAMPLE DATABASE TABLES So we need to create some sample database as the image below Below is the sql scripts for these tables DROP TABLE IF EXISTS jdbc_customer; CREATE TABLE jdbc_customer (customer_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, full_name VARCHAR(50), email VARCHAR(50) NOT NULL UNIQUE, birth_date DATE, gender VARCHAR(50)); INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Maggee Donald&#39;, &#39;mdonald0@marriott.com&#39;, &#39;1987-06-13&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Arni Sturch&#39;, &#39;asturch1@bbb.org&#39;, &#39;1981-05-02&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Abbot Angel&#39;, &#39;aangel2@ihg.com&#39;, &#39;1984-12-23&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Georgeta Drackford&#39;, &#39;gdrackford3@nature.com&#39;, &#39;1993-11-02&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Marin Pollendine&#39;, &#39;mpollendine4@reddit.com&#39;, &#39;1999-10-21&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Lloyd Garber&#39;, &#39;lgarber5@wsj.com&#39;, &#39;1991-08-28&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Savina Manwaring&#39;, &#39;smanwaring6@sfgate.com&#39;, &#39;1996-01-03&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Daniel Hansard&#39;, &#39;dhansard7@rediff.com&#39;, &#39;1986-09-18&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Patricia Titherington&#39;, &#39;ptitherington8@ehow.com&#39;, &#39;1994-07-12&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Meta Boleyn&#39;, &#39;mboleyn9@ox.ac.uk&#39;, &#39;1982-05-20&#39;, &#39;F&#39;) ; --- DROP TABLE IF EXISTS jdbc_merchant; CREATE TABLE jdbc_merchant (merchant_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, merchant_name VARCHAR(50), email VARCHAR(50), description text); INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Heathcote Inc&#39;, &#39;rgilkes0@e-recht24.de&#39;, &#39;Maecenas tristique, est et tempus semper, est quam pharetra magna, ac consequat metus sapien ut nunc. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Mauris viverra diam vitae quam. Suspendisse potenti.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Volkman, Roberts and Dietrich&#39;, &#39;ebenstead1@auda.org.au&#39;, &#39;Nullam porttitor lacus at turpis. Donec posuere metus vitae ipsum. Aliquam non mauris.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Moore LLC&#39;, &#39;mtillman2@house.gov&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Purdy and Sons&#39;, &#39;jhambelton3@wikipedia.org&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Kuhic-Parisian&#39;, &#39;dmccreery4@wix.com&#39;, &#39;Curabitur at ipsum ac tellus semper interdum. Mauris ullamcorper purus sit amet nulla. Quisque arcu libero, rutrum ac, lobortis vel, dapibus at, diam.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Greenfelder-Emard&#39;, &#39;eclara5@webeden.co.uk&#39;, &#39;Duis aliquam convallis nunc. Proin at turpis a pede posuere nonummy. Integer non velit.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Armstrong and Sons&#39;, &#39;mhartle6@phoca.cz&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Goyette-Pollich&#39;, &#39;vblowin7@jiathis.com&#39;, &#39;In quis justo. Maecenas rhoncus aliquam lacus. Morbi quis tortor id nulla ultrices aliquet.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Yundt Group&#39;, &#39;larnli8@pen.io&#39;, &#39;Morbi porttitor lorem id ligula. Suspendisse ornare consequat lectus. In est risus, auctor sed, tristique in, tempus sit amet, sem.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Wintheiser-Cummerata&#39;, &#39;cbartzen9@archive.org&#39;, NULL) ; --- CREATE OR REPLACE PROCEDURE public.update_jdbc_customer(existing_customer_id bigint, new_full_name CHARACTER varying) LANGUAGE &#39;plpgsql&#39; AS $BODY$ declare dynamic_sql varchar(1000); begin dynamic_sql = &#39;update jdbc_customer set full_name = &#39;&#39;&#39; || new_full_name || &#39;&#39;&#39; where customer_id = &#39; || existing_customer_id; execute dynamic_sql; end $BODY$; DROP TABLE IF EXISTS jpa_customer; CREATE TABLE jpa_customer (customer_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, full_name VARCHAR(50), email VARCHAR(50) NOT NULL UNIQUE, birth_date DATE, gender VARCHAR(50)); INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Maggee Donald&#39;, &#39;mdonald0@marriott.com&#39;, &#39;1987-06-13&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Arni Sturch&#39;, &#39;asturch1@bbb.org&#39;, &#39;1981-05-02&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Abbot Angel&#39;, &#39;aangel2@ihg.com&#39;, &#39;1984-12-23&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Georgeta Drackford&#39;, &#39;gdrackford3@nature.com&#39;, &#39;1993-11-02&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Marin Pollendine&#39;, &#39;mpollendine4@reddit.com&#39;, &#39;1999-10-21&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Lloyd Garber&#39;, &#39;lgarber5@wsj.com&#39;, &#39;1991-08-28&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Savina Manwaring&#39;, &#39;smanwaring6@sfgate.com&#39;, &#39;1996-01-03&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Daniel Hansard&#39;, &#39;dhansard7@rediff.com&#39;, &#39;1986-09-18&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Patricia Titherington&#39;, &#39;ptitherington8@ehow.com&#39;, &#39;1994-07-12&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Meta Boleyn&#39;, &#39;mboleyn9@ox.ac.uk&#39;, &#39;1982-05-20&#39;, &#39;F&#39;) ; DROP TABLE IF EXISTS xss_article CASCADE; CREATE TABLE xss_article (article_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, article text NOT NULL); DROP TABLE IF EXISTS basic_auth_user; CREATE TABLE basic_auth_user (user_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, username VARCHAR(150) NOT NULL UNIQUE, password_hash VARCHAR(100) NOT NULL, salt VARCHAR(16) NOT NULL UNIQUE, display_name VARCHAR(50)); INSERT INTO basic_auth_user (user_id, username, password_hash, salt, display_name) VALUES (9999, &#39;b47ae31867bf002df6ffde0a5e1f8bd4c7c371608121cc5edcaf52986d52e8e8&#39;, &#39;$2y$05$b03MQkjNRzjLKyu3R0PEaOW39lOQrrCF5Z1MkM78h6U4ysXQOqpe.&#39;, &#39;wnNJiOOYM3L9OdFq&#39;, &#39;Administrator&#39;) ; INSERT INTO basic_auth_user (user_id, username, password_hash, salt, display_name) VALUES (9998, &#39;f9c34cef4027cd1e547a9ea5a27152e3f24ab18f78baa6e036b67cc43bb44f26&#39;, &#39;$2y$05$RjfNaknMQ1DuRTL1UTfOSOxt9Yze.itnnYY6sbKzSNvPodZ5VSQ96&#39;, &#39;NXOrjNKqpMSwYXPQ&#39;, &#39;Elsa of Arendelle&#39;) ; DROP TABLE IF EXISTS basic_acl_uri; CREATE TABLE basic_acl_uri (uri_id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, METHOD VARCHAR(100) NOT NULL, uri VARCHAR(300) NOT NULL); DROP TABLE IF EXISTS basic_acl_user_uri_ref; CREATE TABLE basic_acl_user_uri_ref (user_id INTEGER, uri_id INTEGER); INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9981, &#39;GET&#39;, &#39;/api/acl/v\d{1,3}/one&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9982, &#39;DELETE&#39;, &#39;/api/acl/v\d{1,3}/one&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9983, &#39;POST&#39;, &#39;/api/acl/v\d{1,3}/anypath/.*&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9984, &#39;GET&#39;, &#39;/api/acl/v\d{1,3}/anypath/.*&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9985, &#39;PUT&#39;, &#39;/api/acl/v\d{1,3}/.*/three&#39;) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9982) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9983) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9984) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9985) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9981) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9982) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9985) ; DROP TABLE IF EXISTS basic_apikey; CREATE TABLE basic_apikey(apikey_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, user_id INT, apikey VARCHAR(64) NOT NULL UNIQUE, expired_at TIMESTAMP WITHOUT TIME ZONE); INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9999, &#39;adminApiKey001&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9999, &#39;adminApiKey002&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9998, &#39;elsaApiKey101&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9998, &#39;elsaApiKey102&#39;, now() + INTERVAL &#39;2 year&#39;) ; TESTING Now, let’s start your service and execute api with the payload as below { &quot;fullName&quot;: &quot;Peter Parker&quot;, &quot;email&quot;: &quot;peter.parker1@marvel.com&quot;, &quot;birthDate&quot;: &quot;2000-12-31&quot;, &quot;gender&quot;: &quot;M&#39;); DROP table jdbc_merchant --&quot; } As you can see in the gender field we will inject the SQL script to delete the table jdbc_merchant. So let’s execute the api with this payload Then you can go to DB to check tables and you will see the table jdbc_merchant has been deleted. EXAMPLE WITH JDBC SPRING FRAMEWORK So if you are using JDBC of Spring framework to create the repository, so it is also not safe with SQL injection. We will use the example above and add some implementations as below STRUCTURE REPOSITORY So let’s add more a repository interface JdbcCustomerCrudRepository.java in repository package as below package com.example.security.repository; import com.example.security.entity.JdbcCustomer; import org.springframework.data.jdbc.repository.query.Query; import org.springframework.data.repository.CrudRepository; import org.springframework.data.repository.query.Param; import org.springframework.stereotype.Repository; import java.util.List; @Repository public interface JdbcCustomerCrudRepository extends CrudRepository&lt;JdbcCustomer, Integer&gt; { List&lt;JdbcCustomer&gt; findByEmail(String email); List&lt;JdbcCustomer&gt; findByGender(String gender); //this is the custom query that will call to a function in DB to update customer @Query(&quot;CALL update_jdbc_customer(:customerId, :newFullName)&quot;) void updateCustomerFullName(@Param(&quot;customerId&quot;) int customerId, @Param(&quot;newFullName&quot;) String newFullName); } API Now, we create another rest api class as below package com.example.security.api.server.sqlinjection; import com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest; import com.example.security.entity.JdbcCustomer; import com.example.security.repository.JdbcCustomerCrudRepository; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.validation.Valid; import javax.validation.constraints.Pattern; import java.util.List; @RestController @RequestMapping(&quot;/api/sqlinjection/crud/v1&quot;) @Validated public class JdbcCustomerCrudApi { @Autowired private JdbcCustomerCrudRepository repository; @GetMapping(value = &quot;/customer/{email}&quot;) public JdbcCustomer findCustomerByEmail(@PathVariable(required = true, name = &quot;email&quot;) String email) { List&lt;JdbcCustomer&gt; queryResult = repository.findByEmail(email); if (queryResult != null &amp;&amp; !queryResult.isEmpty()) { return queryResult.get(0); } return null; } @GetMapping(value = &quot;/customer&quot;) public List&lt;JdbcCustomer&gt; findCustomersByGender( @Pattern(regexp = &quot;^[MF]$&quot;, message = &quot;Invalid gender&quot;) @RequestParam(required = true, name = &quot;genderCode&quot;) String genderCode) { return repository.findByGender(genderCode); } @PostMapping(value = &quot;/customer&quot;) public void createCustomer(@RequestBody(required = true) @Valid JdbcCustomer newCustomer) { repository.save(newCustomer); } @PatchMapping(value = &quot;/customer/{customerId}&quot;) public void updateCustomerFullName(@PathVariable(required = true, name = &quot;customerId&quot;) int customerId, @RequestBody(required = true) JdbcCustomerPatchRequest request) { repository.updateCustomerFullName(customerId, request.getNewFullName()); } } TESTING Now, let’s start your service and execute api with the payload as below for api creating customer { &quot;fullName&quot;: &quot;Peter Parker&quot;, &quot;email&quot;: &quot;peter.parker1@marvel.com&quot;, &quot;birthDate&quot;: &quot;2000-12-31&quot;, &quot;gender&quot;: &quot;M&#39;); DROP table jdbc_merchant --&quot; } As you can see in the gender field we will inject the SQL script to delete the table jdbc_merchant. So let’s execute the api with this payload Then you can go to DB to check tables and you will see the table jdbc_merchant has not been deleted. why does this happen?. So for the first example we use the concatenated string to build the SQL statement. Let’s see the example below, the input at email or role can be a string variable or an injected SQL script. SELECT * FROM mytable WHERE email = ? AND role = ? -- with vulnerable variable inputs, the sql will be looked like as below SELECT * FROM mytable WHERE email = superman@jla.com AND role = HERO; drop table users When we use the Jdbc Spring Framework, It will help us to build the prepared statement, the vulnerable input will be put into &#39;&#39; as a string value. So jdbc_merchant will not be deleted. -- with vulnerable variable inputs, they will be put into &#39;&#39; as a string value SELECT * FROM mytable WHERE email = &#39;superman@jla.com&#39; AND role = &#39;HERO; drop table users&#39; -- this is the query that jdbc spring generated. -- you can see, it&#39;s safe from injected SQL. INSERT INTO public.jdbc_customer (customer_id, full_name, email, birth_date, gender) VALUES(11, &#39;Peter Parker&#39;, &#39;peter.parker@marvel.com&#39;, &#39;2000-12-31&#39;, &#39;M&#39;&#39;); DROP table jdbc_merchant --&#39;); So for now, let’s execuste the update customer api which is vulnerable by custom query, this query will call to a store procedure to update the table. After the api is executed, then you can see we received 500 internal server error { &quot;newFullName&quot;: &quot;Peter Parker&#39;; drop table jdbc_merchant --&quot; } Now, let’s check the DB again, then you can see the table jdbc_merchant has been deleted, when the procedure is executed to update customer fullname." />
<link rel="canonical" href="/jekyll/update/2021/09/26/java-springboot-security-SQL-Injection.html" />
<meta property="og:url" content="/jekyll/update/2021/09/26/java-springboot-security-SQL-Injection.html" />
<meta property="og:site_name" content="StepByStep" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-26T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Spring Security: SQL Injection" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"/jekyll/update/2021/09/26/java-springboot-security-SQL-Injection.html","dateModified":"2021-09-26T00:00:00+07:00","datePublished":"2021-09-26T00:00:00+07:00","headline":"Spring Security: SQL Injection","mainEntityOfPage":{"@type":"WebPage","@id":"/jekyll/update/2021/09/26/java-springboot-security-SQL-Injection.html"},"description":"WHAT IS THE SQL INJECTION? SQL injection is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. It generally allows an attacker to view data that they are not normally able to retrieve. This might include data belonging to other users, or any other data that the application itself is able to access. In many cases, an attacker can modify or delete this data, causing persistent changes to the application’s content or behavior. More information An injection attack can happen when we execute dynamic code based on user input. Dynamic code is code created on runtime based on user input, such as SQL statement with parameters. It’s like injecting a dangerous piece of string into input string, hence the name injection. Application might not know which string is dangerous, so the application will execute all the string, including dangerous one. For example: we expect that the SQL will query for us the name of people following the email. If application is vulnerable, sql injection can inject this dangerous code. --Expected SELECT name FROM people WHERE email = ... --Injected DROP TABLE users --So application will executed both SELECT name FROM people WHERE email =... DROP TABLE users SQL injection took place on user input, on API it can be many ways like request parameters, path variables or request body. Api code is vulnerable for sql injection in database access part . If the code build dynamic statement by joining strings from user input then it will open the security hole. We usually misunderstand that using framework is safe from SQL injection. For example, you are using Spring JPA or Hibernate, so you think that you are safe from SQL Injection. The answer is no, the framework helps us avoid create hand codes SQL statements but framework doesn’t prevent us to write vulnerable code. If you still use string join to build sql statements, framework will not validate it against SQL injection. EXAMPLE WITH JDBC CORE So, let’s take an example so you can understand it deeper. Let’s create a gradle string boot service with apis receive a request and execute a vulnerable sql into the database. DEPENDENCIES If you don’t know how to create a spring boot service with gradlew, you can view this post. We will use postgressql, So if you don’t know how to install this DB, you can view this post dependencies { compileOnly &#39;org.projectlombok:lombok:1.18.20&#39; annotationProcessor &#39;org.projectlombok:lombok:1.18.20&#39; implementation &#39;org.springframework.boot:spring-boot-starter-data-jdbc&#39; implementation &#39;org.springdoc:springdoc-openapi-ui:1.5.10&#39; implementation &#39;org.springframework.boot:spring-boot-starter-web&#39; testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39; implementation &#39;org.postgresql:postgresql:42.2.23&#39; } STRUCTURE Then you need to create some package as the image below API Let’s create an api class JdbcCustomerCrudApi which will contain an api as below package com.example.security.api.server.sqlinjection; import com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest; import com.example.security.entity.JdbcCustomer; import com.example.security.repository.JdbcCustomerDangerRepository; import com.fasterxml.jackson.databind.ObjectWriter; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.validation.constraints.Pattern; import java.util.List; import java.util.Objects; @RestController @RequestMapping(&quot;/api/sqlinjection/danger/v1&quot;) @Validated public class JdbcCustomerCrudApi { @Autowired private JdbcCustomerDangerRepository repository; @PostMapping(value = &quot;/customers&quot;) public void createCustomer(@RequestBody(required = true) JdbcCustomer newCustomer) { repository.createCustomer(newCustomer); } } ENTITY You need to create an entity object to receive data from request map it into sql statement. package com.example.security.entity; import lombok.AllArgsConstructor; import lombok.Getter; import lombok.NoArgsConstructor; import lombok.Setter; import org.springframework.data.annotation.Id; import java.time.LocalDate; @Getter @Setter @NoArgsConstructor @AllArgsConstructor public class JdbcCustomer { @Id private int customerId; private String fullName; private String email; private LocalDate birthDate; private String gender; } REPOSITORY So now, we will create a repository class which will contain the vulnerable sql statement. package com.example.security.repository; import com.example.security.entity.JdbcCustomer; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jdbc.core.BeanPropertyRowMapper; import org.springframework.jdbc.core.JdbcTemplate; import org.springframework.stereotype.Repository; import java.sql.ResultSet; import java.sql.SQLException; import java.util.List; import java.util.Optional; @Repository public class JdbcCustomerDangerRepository { @Autowired private JdbcTemplate jdbcTemplate; private JdbcCustomer mapToCustomer(ResultSet rs, long rowNum) throws SQLException { JdbcCustomer customer = new JdbcCustomer(); Optional.ofNullable(rs.getDate(&quot;birth_date&quot;)).ifPresent(b -&gt; customer.setBirthDate(b.toLocalDate())); customer.setCustomerId(rs.getInt(&quot;customer_id&quot;)); customer.setEmail(rs.getString(&quot;email&quot;)); customer.setFullName(rs.getString(&quot;full_name&quot;)); customer.setGender(rs.getString(&quot;gender&quot;)); return customer; } public void createCustomer(JdbcCustomer newCustomer) { String sql = &quot;INSERT INTO jdbc_customer(full_name, email, birth_date, gender) VALUES (&quot; + &quot;&#39;&quot; + newCustomer.getFullName() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getEmail() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getBirthDate() + &quot;&#39;, &quot; + &quot;&#39;&quot; + newCustomer.getGender() + &quot;&#39;, &quot; + &quot;&#39;)&quot;; jdbcTemplate.execute(sql); } } SAMPLE DATABASE TABLES So we need to create some sample database as the image below Below is the sql scripts for these tables DROP TABLE IF EXISTS jdbc_customer; CREATE TABLE jdbc_customer (customer_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, full_name VARCHAR(50), email VARCHAR(50) NOT NULL UNIQUE, birth_date DATE, gender VARCHAR(50)); INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Maggee Donald&#39;, &#39;mdonald0@marriott.com&#39;, &#39;1987-06-13&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Arni Sturch&#39;, &#39;asturch1@bbb.org&#39;, &#39;1981-05-02&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Abbot Angel&#39;, &#39;aangel2@ihg.com&#39;, &#39;1984-12-23&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Georgeta Drackford&#39;, &#39;gdrackford3@nature.com&#39;, &#39;1993-11-02&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Marin Pollendine&#39;, &#39;mpollendine4@reddit.com&#39;, &#39;1999-10-21&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Lloyd Garber&#39;, &#39;lgarber5@wsj.com&#39;, &#39;1991-08-28&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Savina Manwaring&#39;, &#39;smanwaring6@sfgate.com&#39;, &#39;1996-01-03&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Daniel Hansard&#39;, &#39;dhansard7@rediff.com&#39;, &#39;1986-09-18&#39;, &#39;M&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Patricia Titherington&#39;, &#39;ptitherington8@ehow.com&#39;, &#39;1994-07-12&#39;, &#39;F&#39;) ; INSERT INTO jdbc_customer (full_name, email, birth_date, gender) VALUES (&#39;Meta Boleyn&#39;, &#39;mboleyn9@ox.ac.uk&#39;, &#39;1982-05-20&#39;, &#39;F&#39;) ; --- DROP TABLE IF EXISTS jdbc_merchant; CREATE TABLE jdbc_merchant (merchant_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, merchant_name VARCHAR(50), email VARCHAR(50), description text); INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Heathcote Inc&#39;, &#39;rgilkes0@e-recht24.de&#39;, &#39;Maecenas tristique, est et tempus semper, est quam pharetra magna, ac consequat metus sapien ut nunc. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Mauris viverra diam vitae quam. Suspendisse potenti.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Volkman, Roberts and Dietrich&#39;, &#39;ebenstead1@auda.org.au&#39;, &#39;Nullam porttitor lacus at turpis. Donec posuere metus vitae ipsum. Aliquam non mauris.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Moore LLC&#39;, &#39;mtillman2@house.gov&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Purdy and Sons&#39;, &#39;jhambelton3@wikipedia.org&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Kuhic-Parisian&#39;, &#39;dmccreery4@wix.com&#39;, &#39;Curabitur at ipsum ac tellus semper interdum. Mauris ullamcorper purus sit amet nulla. Quisque arcu libero, rutrum ac, lobortis vel, dapibus at, diam.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Greenfelder-Emard&#39;, &#39;eclara5@webeden.co.uk&#39;, &#39;Duis aliquam convallis nunc. Proin at turpis a pede posuere nonummy. Integer non velit.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Armstrong and Sons&#39;, &#39;mhartle6@phoca.cz&#39;, NULL) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Goyette-Pollich&#39;, &#39;vblowin7@jiathis.com&#39;, &#39;In quis justo. Maecenas rhoncus aliquam lacus. Morbi quis tortor id nulla ultrices aliquet.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Yundt Group&#39;, &#39;larnli8@pen.io&#39;, &#39;Morbi porttitor lorem id ligula. Suspendisse ornare consequat lectus. In est risus, auctor sed, tristique in, tempus sit amet, sem.&#39;) ; INSERT INTO jdbc_merchant (merchant_name, email, description) VALUES (&#39;Wintheiser-Cummerata&#39;, &#39;cbartzen9@archive.org&#39;, NULL) ; --- CREATE OR REPLACE PROCEDURE public.update_jdbc_customer(existing_customer_id bigint, new_full_name CHARACTER varying) LANGUAGE &#39;plpgsql&#39; AS $BODY$ declare dynamic_sql varchar(1000); begin dynamic_sql = &#39;update jdbc_customer set full_name = &#39;&#39;&#39; || new_full_name || &#39;&#39;&#39; where customer_id = &#39; || existing_customer_id; execute dynamic_sql; end $BODY$; DROP TABLE IF EXISTS jpa_customer; CREATE TABLE jpa_customer (customer_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, full_name VARCHAR(50), email VARCHAR(50) NOT NULL UNIQUE, birth_date DATE, gender VARCHAR(50)); INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Maggee Donald&#39;, &#39;mdonald0@marriott.com&#39;, &#39;1987-06-13&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Arni Sturch&#39;, &#39;asturch1@bbb.org&#39;, &#39;1981-05-02&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Abbot Angel&#39;, &#39;aangel2@ihg.com&#39;, &#39;1984-12-23&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Georgeta Drackford&#39;, &#39;gdrackford3@nature.com&#39;, &#39;1993-11-02&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Marin Pollendine&#39;, &#39;mpollendine4@reddit.com&#39;, &#39;1999-10-21&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Lloyd Garber&#39;, &#39;lgarber5@wsj.com&#39;, &#39;1991-08-28&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Savina Manwaring&#39;, &#39;smanwaring6@sfgate.com&#39;, &#39;1996-01-03&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Daniel Hansard&#39;, &#39;dhansard7@rediff.com&#39;, &#39;1986-09-18&#39;, &#39;M&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Patricia Titherington&#39;, &#39;ptitherington8@ehow.com&#39;, &#39;1994-07-12&#39;, &#39;F&#39;) ; INSERT INTO jpa_customer (full_name, email, birth_date, gender) VALUES (&#39;Meta Boleyn&#39;, &#39;mboleyn9@ox.ac.uk&#39;, &#39;1982-05-20&#39;, &#39;F&#39;) ; DROP TABLE IF EXISTS xss_article CASCADE; CREATE TABLE xss_article (article_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, article text NOT NULL); DROP TABLE IF EXISTS basic_auth_user; CREATE TABLE basic_auth_user (user_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, username VARCHAR(150) NOT NULL UNIQUE, password_hash VARCHAR(100) NOT NULL, salt VARCHAR(16) NOT NULL UNIQUE, display_name VARCHAR(50)); INSERT INTO basic_auth_user (user_id, username, password_hash, salt, display_name) VALUES (9999, &#39;b47ae31867bf002df6ffde0a5e1f8bd4c7c371608121cc5edcaf52986d52e8e8&#39;, &#39;$2y$05$b03MQkjNRzjLKyu3R0PEaOW39lOQrrCF5Z1MkM78h6U4ysXQOqpe.&#39;, &#39;wnNJiOOYM3L9OdFq&#39;, &#39;Administrator&#39;) ; INSERT INTO basic_auth_user (user_id, username, password_hash, salt, display_name) VALUES (9998, &#39;f9c34cef4027cd1e547a9ea5a27152e3f24ab18f78baa6e036b67cc43bb44f26&#39;, &#39;$2y$05$RjfNaknMQ1DuRTL1UTfOSOxt9Yze.itnnYY6sbKzSNvPodZ5VSQ96&#39;, &#39;NXOrjNKqpMSwYXPQ&#39;, &#39;Elsa of Arendelle&#39;) ; DROP TABLE IF EXISTS basic_acl_uri; CREATE TABLE basic_acl_uri (uri_id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, METHOD VARCHAR(100) NOT NULL, uri VARCHAR(300) NOT NULL); DROP TABLE IF EXISTS basic_acl_user_uri_ref; CREATE TABLE basic_acl_user_uri_ref (user_id INTEGER, uri_id INTEGER); INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9981, &#39;GET&#39;, &#39;/api/acl/v\\d{1,3}/one&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9982, &#39;DELETE&#39;, &#39;/api/acl/v\\d{1,3}/one&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9983, &#39;POST&#39;, &#39;/api/acl/v\\d{1,3}/anypath/.*&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9984, &#39;GET&#39;, &#39;/api/acl/v\\d{1,3}/anypath/.*&#39;) ; INSERT INTO basic_acl_uri (uri_id, METHOD, uri) VALUES (9985, &#39;PUT&#39;, &#39;/api/acl/v\\d{1,3}/.*/three&#39;) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9982) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9983) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9984) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9999, 9985) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9981) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9982) ; INSERT INTO basic_acl_user_uri_ref (user_id, uri_id) VALUES (9998, 9985) ; DROP TABLE IF EXISTS basic_apikey; CREATE TABLE basic_apikey(apikey_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, user_id INT, apikey VARCHAR(64) NOT NULL UNIQUE, expired_at TIMESTAMP WITHOUT TIME ZONE); INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9999, &#39;adminApiKey001&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9999, &#39;adminApiKey002&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9998, &#39;elsaApiKey101&#39;, now() + INTERVAL &#39;2 year&#39;) ; INSERT INTO basic_apikey(user_id, apikey, expired_at) VALUES (9998, &#39;elsaApiKey102&#39;, now() + INTERVAL &#39;2 year&#39;) ; TESTING Now, let’s start your service and execute api with the payload as below { &quot;fullName&quot;: &quot;Peter Parker&quot;, &quot;email&quot;: &quot;peter.parker1@marvel.com&quot;, &quot;birthDate&quot;: &quot;2000-12-31&quot;, &quot;gender&quot;: &quot;M&#39;); DROP table jdbc_merchant --&quot; } As you can see in the gender field we will inject the SQL script to delete the table jdbc_merchant. So let’s execute the api with this payload Then you can go to DB to check tables and you will see the table jdbc_merchant has been deleted. EXAMPLE WITH JDBC SPRING FRAMEWORK So if you are using JDBC of Spring framework to create the repository, so it is also not safe with SQL injection. We will use the example above and add some implementations as below STRUCTURE REPOSITORY So let’s add more a repository interface JdbcCustomerCrudRepository.java in repository package as below package com.example.security.repository; import com.example.security.entity.JdbcCustomer; import org.springframework.data.jdbc.repository.query.Query; import org.springframework.data.repository.CrudRepository; import org.springframework.data.repository.query.Param; import org.springframework.stereotype.Repository; import java.util.List; @Repository public interface JdbcCustomerCrudRepository extends CrudRepository&lt;JdbcCustomer, Integer&gt; { List&lt;JdbcCustomer&gt; findByEmail(String email); List&lt;JdbcCustomer&gt; findByGender(String gender); //this is the custom query that will call to a function in DB to update customer @Query(&quot;CALL update_jdbc_customer(:customerId, :newFullName)&quot;) void updateCustomerFullName(@Param(&quot;customerId&quot;) int customerId, @Param(&quot;newFullName&quot;) String newFullName); } API Now, we create another rest api class as below package com.example.security.api.server.sqlinjection; import com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest; import com.example.security.entity.JdbcCustomer; import com.example.security.repository.JdbcCustomerCrudRepository; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.validation.Valid; import javax.validation.constraints.Pattern; import java.util.List; @RestController @RequestMapping(&quot;/api/sqlinjection/crud/v1&quot;) @Validated public class JdbcCustomerCrudApi { @Autowired private JdbcCustomerCrudRepository repository; @GetMapping(value = &quot;/customer/{email}&quot;) public JdbcCustomer findCustomerByEmail(@PathVariable(required = true, name = &quot;email&quot;) String email) { List&lt;JdbcCustomer&gt; queryResult = repository.findByEmail(email); if (queryResult != null &amp;&amp; !queryResult.isEmpty()) { return queryResult.get(0); } return null; } @GetMapping(value = &quot;/customer&quot;) public List&lt;JdbcCustomer&gt; findCustomersByGender( @Pattern(regexp = &quot;^[MF]$&quot;, message = &quot;Invalid gender&quot;) @RequestParam(required = true, name = &quot;genderCode&quot;) String genderCode) { return repository.findByGender(genderCode); } @PostMapping(value = &quot;/customer&quot;) public void createCustomer(@RequestBody(required = true) @Valid JdbcCustomer newCustomer) { repository.save(newCustomer); } @PatchMapping(value = &quot;/customer/{customerId}&quot;) public void updateCustomerFullName(@PathVariable(required = true, name = &quot;customerId&quot;) int customerId, @RequestBody(required = true) JdbcCustomerPatchRequest request) { repository.updateCustomerFullName(customerId, request.getNewFullName()); } } TESTING Now, let’s start your service and execute api with the payload as below for api creating customer { &quot;fullName&quot;: &quot;Peter Parker&quot;, &quot;email&quot;: &quot;peter.parker1@marvel.com&quot;, &quot;birthDate&quot;: &quot;2000-12-31&quot;, &quot;gender&quot;: &quot;M&#39;); DROP table jdbc_merchant --&quot; } As you can see in the gender field we will inject the SQL script to delete the table jdbc_merchant. So let’s execute the api with this payload Then you can go to DB to check tables and you will see the table jdbc_merchant has not been deleted. why does this happen?. So for the first example we use the concatenated string to build the SQL statement. Let’s see the example below, the input at email or role can be a string variable or an injected SQL script. SELECT * FROM mytable WHERE email = ? AND role = ? -- with vulnerable variable inputs, the sql will be looked like as below SELECT * FROM mytable WHERE email = superman@jla.com AND role = HERO; drop table users When we use the Jdbc Spring Framework, It will help us to build the prepared statement, the vulnerable input will be put into &#39;&#39; as a string value. So jdbc_merchant will not be deleted. -- with vulnerable variable inputs, they will be put into &#39;&#39; as a string value SELECT * FROM mytable WHERE email = &#39;superman@jla.com&#39; AND role = &#39;HERO; drop table users&#39; -- this is the query that jdbc spring generated. -- you can see, it&#39;s safe from injected SQL. INSERT INTO public.jdbc_customer (customer_id, full_name, email, birth_date, gender) VALUES(11, &#39;Peter Parker&#39;, &#39;peter.parker@marvel.com&#39;, &#39;2000-12-31&#39;, &#39;M&#39;&#39;); DROP table jdbc_merchant --&#39;); So for now, let’s execuste the update customer api which is vulnerable by custom query, this query will call to a store procedure to update the table. After the api is executed, then you can see we received 500 internal server error { &quot;newFullName&quot;: &quot;Peter Parker&#39;; drop table jdbc_merchant --&quot; } Now, let’s check the DB again, then you can see the table jdbc_merchant has been deleted, when the procedure is executed to update customer fullname.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="StepByStep" /><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZ8G5007GK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NZ8G5007GK');
</script></head><body>
  <div class="container-flush">
    <div class="row"><!-- navigation bar -->
<div class="col-lg-12">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="banner"><a class="navbar-brand site-title" rel="author" href="/">StepByStep</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="nav navbar-nav"><li class="nav-item active">
          <a class="nav-link" href="/about/">About</a>
        </li><li class="nav-item active">
          <a class="nav-link" href="/ci-cd/">CI-CD</a>
        </li><li class="nav-item active">
          <a class="nav-link" href="/database/">Database</a>
        </li><li class="nav-item active">
          <a class="nav-link" href="/docker/">Docker</a>
        </li><li class="nav-item active">
          <a class="nav-link" href="/">Java</a>
        </li><li class="nav-item active">
          <a class="nav-link" href="/python/">Python</a>
        </li></ul>
    </div><!-- Html Elements for Search -->
    <div id="search-container" class="btn-group">
      <input type="text" id="search-input" placeholder="search...">
      <button id="clear">clear</button>
      <ul id="results-container"></ul>
    </div>

    <!-- Script pointing to search-script.js -->
    <script src="/java-scripts/search-script.js" type="text/javascript"></script>

    <!-- Configuration -->
    <script>
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json'
      })
    </script>

    <!-- search clear -->
    <script>
      window.addEventListener('load', () => {
          const button = document.querySelector('#clear');
          button.addEventListener('click', () => {
              document.querySelector('#search-input').value = "";
              document.querySelector('#results-container').innerHTML = "";
          });
      }); 
  </script>
  </nav>
</div></div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
  <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
      <h1 class="post-title p-name" itemprop="name headline">Spring Security: SQL Injection</h1>
      <p class="post-meta">
        <time class="dt-published" datetime="2021-09-26T00:00:00+07:00" itemprop="datePublished">Sep 26, 2021
        </time></p>
    </header>
  
    <div class="post-content e-content" itemprop="articleBody">
      <h2 id="what-is-the-sql-injection">WHAT IS THE SQL INJECTION?</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SQL injection</code> is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. It generally allows an attacker to view data that they are not normally able to retrieve. This might include data belonging to other users, or any other data that the application itself is able to access. In many cases, an attacker can modify or delete this data, causing persistent changes to the application’s content or behavior.</p>
  </li>
  <li>
    <p><a href="https://portswigger.net/web-security/sql-injection">More information</a></p>
  </li>
  <li>
    <p>An injection attack can happen when we execute dynamic code based on user input. Dynamic code is code created on runtime based on user input, such as SQL statement with parameters. It’s like injecting a dangerous piece of string into input string, hence the name injection. Application might not know which string is dangerous, so the application will execute all the string, including dangerous one.</p>
  </li>
  <li>
    <p>For example: we expect that the SQL will query for us the <code class="language-plaintext highlighter-rouge">name</code> of people following the <code class="language-plaintext highlighter-rouge">email</code>. If application is vulnerable, sql injection can inject this dangerous code.</p>
  </li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">--Expected</span>
<span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">people</span> <span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span> <span class="p">...</span>

<span class="c1">--Injected</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">users</span>

<span class="c1">--So application will executed both</span>
<span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">people</span> <span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span><span class="p">...</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">users</span>

</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SQL injection</code> took place on user input, on API it can be many ways like <code class="language-plaintext highlighter-rouge">request parameters</code>, <code class="language-plaintext highlighter-rouge">path variables</code> or <code class="language-plaintext highlighter-rouge">request body</code>.</li>
  <li>Api code is vulnerable for sql injection in database access part . If the code build dynamic statement by joining strings from user input then it will open the security hole.</li>
  <li>We usually misunderstand that using framework is safe from SQL injection. For example, you are using <code class="language-plaintext highlighter-rouge">Spring JPA or Hibernate</code>, so you think that you are safe from SQL Injection. The answer is no, the framework helps us avoid create <code class="language-plaintext highlighter-rouge">hand codes SQL statements</code> but framework doesn’t prevent us to write vulnerable code. If you still use string join to build sql statements, framework will not validate it against SQL injection.</li>
</ul>

<h2 id="example-with-jdbc-core">EXAMPLE WITH JDBC CORE</h2>

<ul>
  <li>So, let’s take an example so you can understand it deeper. Let’s create a gradle string boot service with apis receive a request and execute a vulnerable sql into the database.</li>
</ul>

<h3 id="dependencies">DEPENDENCIES</h3>

<ul>
  <li>
    <p>If you don’t know how to create a spring boot service with gradlew, you can view <a href="/2021-09-18-java-springboot-gradle-basic-concepts.html">this post</a>.</p>
  </li>
  <li>
    <p>We will use <code class="language-plaintext highlighter-rouge">postgressql</code>, So if you don’t know how to install this DB, you can view <a href="_docker-posts/2021-07-08-docker-for-creating-database.html">this post</a></p>
  </li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">dependencies</span> <span class="o">{</span>

	<span class="n">compileOnly</span> <span class="s1">'org.projectlombok:lombok:1.18.20'</span>
	<span class="n">annotationProcessor</span> <span class="s1">'org.projectlombok:lombok:1.18.20'</span>
	<span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-data-jdbc'</span>
	<span class="n">implementation</span> <span class="s1">'org.springdoc:springdoc-openapi-ui:1.5.10'</span>

	<span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>
	<span class="n">testImplementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-test'</span>
	<span class="n">implementation</span> <span class="s1">'org.postgresql:postgresql:42.2.23'</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="structure">STRUCTURE</h3>

<ul>
  <li>Then you need to create some package as the image below</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-structure-project.PNG"><img src="/assets/images/spring-boot-sql-injection-structure-project.PNG" alt="sql injection project structure" title="sql injection project structure" /></a></p>

<h3 id="api">API</h3>

<ul>
  <li>Let’s create an api class <code class="language-plaintext highlighter-rouge">JdbcCustomerCrudApi</code> which will contain an api as below</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">package</span> <span class="nn">com.example.security.api.server.sqlinjection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.entity.JdbcCustomer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.repository.JdbcCustomerDangerRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/sqlinjection/danger/v1"</span><span class="o">)</span>
<span class="nd">@Validated</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcCustomerCrudApi</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcCustomerDangerRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/customers"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createCustomer</span><span class="o">(</span><span class="nd">@RequestBody</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">JdbcCustomer</span> <span class="n">newCustomer</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">createCustomer</span><span class="o">(</span><span class="n">newCustomer</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<h3 id="entity">ENTITY</h3>

<ul>
  <li>You need to create an entity object to receive data from request map it into sql statement.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">package</span> <span class="nn">com.example.security.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Getter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Setter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDate</span><span class="o">;</span>

<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcCustomer</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">customerId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">fullName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">LocalDate</span> <span class="n">birthDate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">gender</span><span class="o">;</span>

<span class="o">}</span>

</code></pre></div></div>

<h3 id="repository">REPOSITORY</h3>

<ul>
  <li>So now, we will create a repository class which will contain the vulnerable sql statement.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">package</span> <span class="nn">com.example.security.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.entity.JdbcCustomer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.BeanPropertyRowMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcCustomerDangerRepository</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>


    <span class="kd">private</span> <span class="nc">JdbcCustomer</span> <span class="nf">mapToCustomer</span><span class="o">(</span><span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rowNum</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">JdbcCustomer</span> <span class="n">customer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcCustomer</span><span class="o">();</span>
        <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">"birth_date"</span><span class="o">)).</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">customer</span><span class="o">.</span><span class="na">setBirthDate</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">toLocalDate</span><span class="o">()));</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setCustomerId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"customer_id"</span><span class="o">));</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"email"</span><span class="o">));</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setFullName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"full_name"</span><span class="o">));</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setGender</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"gender"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">customer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createCustomer</span><span class="o">(</span><span class="nc">JdbcCustomer</span> <span class="n">newCustomer</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"INSERT INTO jdbc_customer(full_name, email, birth_date, gender) VALUES ("</span> <span class="o">+</span>
                <span class="s">"'"</span> <span class="o">+</span> <span class="n">newCustomer</span><span class="o">.</span><span class="na">getFullName</span><span class="o">()</span> <span class="o">+</span>           <span class="s">"', "</span> <span class="o">+</span>
                <span class="s">"'"</span> <span class="o">+</span> <span class="n">newCustomer</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()</span> <span class="o">+</span>              <span class="s">"', "</span> <span class="o">+</span>
                <span class="s">"'"</span> <span class="o">+</span> <span class="n">newCustomer</span><span class="o">.</span><span class="na">getBirthDate</span><span class="o">()</span> <span class="o">+</span>          <span class="s">"', "</span> <span class="o">+</span>
                <span class="s">"'"</span> <span class="o">+</span> <span class="n">newCustomer</span><span class="o">.</span><span class="na">getGender</span><span class="o">()</span> <span class="o">+</span>             <span class="s">"', "</span> <span class="o">+</span>
                <span class="s">"')"</span><span class="o">;</span>
        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<h3 id="sample-database-tables">SAMPLE DATABASE TABLES</h3>

<ul>
  <li>So we need to create some sample database as the image below</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-sample-tables.PNG"><img src="/assets/images/spring-boot-sql-injection-sample-tables.PNG" alt="sample tables for sql injection" title="sample tables for sql injection" /></a></p>

<ul>
  <li>Below is the sql scripts for these tables</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">jdbc_customer</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">customer_id</span> <span class="nb">INT</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> 
<span class="n">full_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
<span class="n">birth_date</span> <span class="nb">DATE</span><span class="p">,</span> <span class="n">gender</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Maggee Donald'</span><span class="p">,</span> <span class="s1">'mdonald0@marriott.com'</span><span class="p">,</span> <span class="s1">'1987-06-13'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Arni Sturch'</span><span class="p">,</span> <span class="s1">'asturch1@bbb.org'</span><span class="p">,</span> <span class="s1">'1981-05-02'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Abbot Angel'</span><span class="p">,</span> <span class="s1">'aangel2@ihg.com'</span><span class="p">,</span> <span class="s1">'1984-12-23'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Georgeta Drackford'</span><span class="p">,</span> <span class="s1">'gdrackford3@nature.com'</span><span class="p">,</span> <span class="s1">'1993-11-02'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Marin Pollendine'</span><span class="p">,</span> <span class="s1">'mpollendine4@reddit.com'</span><span class="p">,</span> <span class="s1">'1999-10-21'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Lloyd Garber'</span><span class="p">,</span> <span class="s1">'lgarber5@wsj.com'</span><span class="p">,</span> <span class="s1">'1991-08-28'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Savina Manwaring'</span><span class="p">,</span> <span class="s1">'smanwaring6@sfgate.com'</span><span class="p">,</span> <span class="s1">'1996-01-03'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Daniel Hansard'</span><span class="p">,</span> <span class="s1">'dhansard7@rediff.com'</span><span class="p">,</span> <span class="s1">'1986-09-18'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Patricia Titherington'</span><span class="p">,</span> <span class="s1">'ptitherington8@ehow.com'</span><span class="p">,</span> <span class="s1">'1994-07-12'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Meta Boleyn'</span><span class="p">,</span> <span class="s1">'mboleyn9@ox.ac.uk'</span><span class="p">,</span> <span class="s1">'1982-05-20'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>

<span class="c1">---</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">jdbc_merchant</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_id</span> <span class="nb">INT</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="n">merchant_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="n">description</span> <span class="nb">text</span><span class="p">);</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Heathcote Inc'</span><span class="p">,</span> <span class="s1">'rgilkes0@e-recht24.de'</span><span class="p">,</span> <span class="s1">'Maecenas tristique, est et tempus semper, est quam pharetra magna, ac consequat metus sapien ut nunc. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Mauris viverra diam vitae quam. Suspendisse potenti.'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Volkman, Roberts and Dietrich'</span><span class="p">,</span> <span class="s1">'ebenstead1@auda.org.au'</span><span class="p">,</span> <span class="s1">'Nullam porttitor lacus at turpis. Donec posuere metus vitae ipsum. Aliquam non mauris.'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Moore LLC'</span><span class="p">,</span> <span class="s1">'mtillman2@house.gov'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Purdy and Sons'</span><span class="p">,</span> <span class="s1">'jhambelton3@wikipedia.org'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Kuhic-Parisian'</span><span class="p">,</span> <span class="s1">'dmccreery4@wix.com'</span><span class="p">,</span> <span class="s1">'Curabitur at ipsum ac tellus semper interdum. Mauris ullamcorper purus sit amet nulla. Quisque arcu libero, rutrum ac, lobortis vel, dapibus at, diam.'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Greenfelder-Emard'</span><span class="p">,</span> <span class="s1">'eclara5@webeden.co.uk'</span><span class="p">,</span> <span class="s1">'Duis aliquam convallis nunc. Proin at turpis a pede posuere nonummy. Integer non velit.'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Armstrong and Sons'</span><span class="p">,</span> <span class="s1">'mhartle6@phoca.cz'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Goyette-Pollich'</span><span class="p">,</span> <span class="s1">'vblowin7@jiathis.com'</span><span class="p">,</span> <span class="s1">'In quis justo. Maecenas rhoncus aliquam lacus. Morbi quis tortor id nulla ultrices aliquet.'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Yundt Group'</span><span class="p">,</span> <span class="s1">'larnli8@pen.io'</span><span class="p">,</span> <span class="s1">'Morbi porttitor lorem id ligula. Suspendisse ornare consequat lectus. In est risus, auctor sed, tristique in, tempus sit amet, sem.'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jdbc_merchant</span> <span class="p">(</span><span class="n">merchant_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Wintheiser-Cummerata'</span><span class="p">,</span> <span class="s1">'cbartzen9@archive.org'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">;</span>

<span class="c1">---</span>

<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">PROCEDURE</span> <span class="k">public</span><span class="p">.</span><span class="n">update_jdbc_customer</span><span class="p">(</span><span class="n">existing_customer_id</span> <span class="nb">bigint</span><span class="p">,</span> <span class="n">new_full_name</span> <span class="nb">CHARACTER</span> <span class="nb">varying</span><span class="p">)</span> <span class="k">LANGUAGE</span> <span class="s1">'plpgsql'</span> <span class="k">AS</span> <span class="err">$</span><span class="n">BODY</span><span class="err">$</span>
<span class="k">declare</span>
    <span class="n">dynamic_sql</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="k">begin</span>
    <span class="n">dynamic_sql</span> <span class="o">=</span> <span class="s1">'update jdbc_customer set full_name = </span><span class="se">''</span><span class="s1">'</span> <span class="o">||</span> <span class="n">new_full_name</span>
	              <span class="o">||</span> <span class="s1">'</span><span class="se">''</span><span class="s1"> where customer_id = '</span> <span class="o">||</span> <span class="n">existing_customer_id</span><span class="p">;</span>

    <span class="k">execute</span> <span class="n">dynamic_sql</span><span class="p">;</span>
<span class="k">end</span>
<span class="err">$</span><span class="n">BODY</span><span class="err">$</span><span class="p">;</span>


<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">jpa_customer</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">customer_id</span> <span class="nb">INT</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="n">full_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
<span class="n">birth_date</span> <span class="nb">DATE</span><span class="p">,</span> <span class="n">gender</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Maggee Donald'</span><span class="p">,</span> <span class="s1">'mdonald0@marriott.com'</span><span class="p">,</span> <span class="s1">'1987-06-13'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Arni Sturch'</span><span class="p">,</span> <span class="s1">'asturch1@bbb.org'</span><span class="p">,</span> <span class="s1">'1981-05-02'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Abbot Angel'</span><span class="p">,</span> <span class="s1">'aangel2@ihg.com'</span><span class="p">,</span> <span class="s1">'1984-12-23'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Georgeta Drackford'</span><span class="p">,</span> <span class="s1">'gdrackford3@nature.com'</span><span class="p">,</span> <span class="s1">'1993-11-02'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Marin Pollendine'</span><span class="p">,</span> <span class="s1">'mpollendine4@reddit.com'</span><span class="p">,</span> <span class="s1">'1999-10-21'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Lloyd Garber'</span><span class="p">,</span> <span class="s1">'lgarber5@wsj.com'</span><span class="p">,</span> <span class="s1">'1991-08-28'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Savina Manwaring'</span><span class="p">,</span> <span class="s1">'smanwaring6@sfgate.com'</span><span class="p">,</span> <span class="s1">'1996-01-03'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Daniel Hansard'</span><span class="p">,</span> <span class="s1">'dhansard7@rediff.com'</span><span class="p">,</span> <span class="s1">'1986-09-18'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Patricia Titherington'</span><span class="p">,</span> <span class="s1">'ptitherington8@ehow.com'</span><span class="p">,</span> <span class="s1">'1994-07-12'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">jpa_customer</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Meta Boleyn'</span><span class="p">,</span> <span class="s1">'mboleyn9@ox.ac.uk'</span><span class="p">,</span> <span class="s1">'1982-05-20'</span><span class="p">,</span> <span class="s1">'F'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">xss_article</span> <span class="k">CASCADE</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">xss_article</span> <span class="p">(</span><span class="n">article_id</span> <span class="nb">INT</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="n">article</span> <span class="nb">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>


<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">basic_auth_user</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">basic_auth_user</span> <span class="p">(</span><span class="n">user_id</span> <span class="nb">INT</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="n">username</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
<span class="n">password_hash</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">salt</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
<span class="n">display_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_auth_user</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">display_name</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="s1">'b47ae31867bf002df6ffde0a5e1f8bd4c7c371608121cc5edcaf52986d52e8e8'</span><span class="p">,</span> <span class="s1">'$2y$05$b03MQkjNRzjLKyu3R0PEaOW39lOQrrCF5Z1MkM78h6U4ysXQOqpe.'</span><span class="p">,</span> <span class="s1">'wnNJiOOYM3L9OdFq'</span><span class="p">,</span> <span class="s1">'Administrator'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_auth_user</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">display_name</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9998</span><span class="p">,</span> <span class="s1">'f9c34cef4027cd1e547a9ea5a27152e3f24ab18f78baa6e036b67cc43bb44f26'</span><span class="p">,</span> <span class="s1">'$2y$05$RjfNaknMQ1DuRTL1UTfOSOxt9Yze.itnnYY6sbKzSNvPodZ5VSQ96'</span><span class="p">,</span> <span class="s1">'NXOrjNKqpMSwYXPQ'</span><span class="p">,</span> <span class="s1">'Elsa of Arendelle'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">basic_acl_uri</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">basic_acl_uri</span> <span class="p">(</span><span class="n">uri_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="k">METHOD</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">uri</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>


<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">basic_acl_user_uri_ref</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">uri_id</span> <span class="nb">INTEGER</span><span class="p">);</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_uri</span> <span class="p">(</span><span class="n">uri_id</span><span class="p">,</span> <span class="k">METHOD</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9981</span><span class="p">,</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/api/acl/v</span><span class="se">\d</span><span class="s1">{1,3}/one'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_uri</span> <span class="p">(</span><span class="n">uri_id</span><span class="p">,</span> <span class="k">METHOD</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9982</span><span class="p">,</span> <span class="s1">'DELETE'</span><span class="p">,</span> <span class="s1">'/api/acl/v</span><span class="se">\d</span><span class="s1">{1,3}/one'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_uri</span> <span class="p">(</span><span class="n">uri_id</span><span class="p">,</span> <span class="k">METHOD</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9983</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'/api/acl/v</span><span class="se">\d</span><span class="s1">{1,3}/anypath/.*'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_uri</span> <span class="p">(</span><span class="n">uri_id</span><span class="p">,</span> <span class="k">METHOD</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9984</span><span class="p">,</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/api/acl/v</span><span class="se">\d</span><span class="s1">{1,3}/anypath/.*'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_uri</span> <span class="p">(</span><span class="n">uri_id</span><span class="p">,</span> <span class="k">METHOD</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9985</span><span class="p">,</span> <span class="s1">'PUT'</span><span class="p">,</span> <span class="s1">'/api/acl/v</span><span class="se">\d</span><span class="s1">{1,3}/.*/three'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9982</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9983</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9984</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9985</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9998</span><span class="p">,</span> <span class="mi">9981</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9998</span><span class="p">,</span> <span class="mi">9982</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_acl_user_uri_ref</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">uri_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9998</span><span class="p">,</span> <span class="mi">9985</span><span class="p">)</span> <span class="p">;</span>


<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">basic_apikey</span><span class="p">;</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">basic_apikey</span><span class="p">(</span><span class="n">apikey_id</span> <span class="nb">INT</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="n">user_id</span> <span class="nb">INT</span><span class="p">,</span> <span class="n">apikey</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
<span class="n">expired_at</span> <span class="nb">TIMESTAMP</span> <span class="k">WITHOUT</span> <span class="nb">TIME</span> <span class="k">ZONE</span><span class="p">);</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_apikey</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">apikey</span><span class="p">,</span> <span class="n">expired_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="s1">'adminApiKey001'</span><span class="p">,</span> <span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">INTERVAL</span> <span class="s1">'2 year'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_apikey</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">apikey</span><span class="p">,</span> <span class="n">expired_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="s1">'adminApiKey002'</span><span class="p">,</span> <span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">INTERVAL</span> <span class="s1">'2 year'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_apikey</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">apikey</span><span class="p">,</span> <span class="n">expired_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9998</span><span class="p">,</span> <span class="s1">'elsaApiKey101'</span><span class="p">,</span> <span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">INTERVAL</span> <span class="s1">'2 year'</span><span class="p">)</span> <span class="p">;</span>


<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">basic_apikey</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">apikey</span><span class="p">,</span> <span class="n">expired_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">9998</span><span class="p">,</span> <span class="s1">'elsaApiKey102'</span><span class="p">,</span> <span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">INTERVAL</span> <span class="s1">'2 year'</span><span class="p">)</span> <span class="p">;</span>

</code></pre></div></div>

<h2 id="testing">TESTING</h2>

<ul>
  <li>Now, let’s start your service and execute api with the payload as below</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"fullName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Peter Parker"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"peter.parker1@marvel.com"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"birthDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000-12-31"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"M'); DROP table jdbc_merchant --"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<ul>
  <li>As you can see in the <strong>gender</strong> field we will inject the SQL script to delete the table <code class="language-plaintext highlighter-rouge">jdbc_merchant</code>. So let’s execute the api with this payload</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-execute-postman.PNG"><img src="/assets/images/spring-boot-sql-injection-execute-postman.PNG" alt="execute api with sql injection" title="execute api with sql injection" /></a></p>

<ul>
  <li>Then you can go to DB to check tables and you will see the table <code class="language-plaintext highlighter-rouge">jdbc_merchant</code> has been deleted.</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-table-deleted.PNG"><img src="/assets/images/spring-boot-sql-injection-table-deleted.PNG" alt="table is deleted in DB" title="table is deleted in DB" /></a></p>

<h2 id="example-with-jdbc-spring-framework">EXAMPLE WITH JDBC SPRING FRAMEWORK</h2>

<ul>
  <li>So if you are using JDBC of Spring framework to create the repository, so it is also not safe with SQL injection. We will use the example above and add some implementations as below</li>
</ul>

<h3 id="structure-1">STRUCTURE</h3>

<p><a href="/assets/images/spring-boot-sql-injection-structure-project-2.PNG"><img src="/assets/images/spring-boot-sql-injection-structure-project-2.PNG" alt="sql injection project structure 2" title="sql injection project structure 2" /></a></p>

<h3 id="repository-1">REPOSITORY</h3>

<ul>
  <li>So let’s add more a repository interface <code class="language-plaintext highlighter-rouge">JdbcCustomerCrudRepository.java</code> in <code class="language-plaintext highlighter-rouge">repository</code> package as below</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">package</span> <span class="nn">com.example.security.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.entity.JdbcCustomer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jdbc.repository.query.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.query.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">JdbcCustomerCrudRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">JdbcCustomer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">JdbcCustomer</span><span class="o">&gt;</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>

	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">JdbcCustomer</span><span class="o">&gt;</span> <span class="nf">findByGender</span><span class="o">(</span><span class="nc">String</span> <span class="n">gender</span><span class="o">);</span>

    <span class="c1">//this is the custom query that will call to a function in DB to update customer</span>
	<span class="nd">@Query</span><span class="o">(</span><span class="s">"CALL update_jdbc_customer(:customerId, :newFullName)"</span><span class="o">)</span>
	<span class="kt">void</span> <span class="nf">updateCustomerFullName</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"customerId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">customerId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"newFullName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">newFullName</span><span class="o">);</span>

<span class="o">}</span>

</code></pre></div></div>

<h3 id="api-1">API</h3>

<ul>
  <li>Now, we create another rest api class as below</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">package</span> <span class="nn">com.example.security.api.server.sqlinjection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.api.request.sqlinjection.JdbcCustomerPatchRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.entity.JdbcCustomer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.repository.JdbcCustomerCrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/sqlinjection/crud/v1"</span><span class="o">)</span>
<span class="nd">@Validated</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcCustomerCrudApi</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcCustomerCrudRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/customer/{email}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JdbcCustomer</span> <span class="nf">findCustomerByEmail</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"email"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">JdbcCustomer</span><span class="o">&gt;</span> <span class="n">queryResult</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queryResult</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">queryResult</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">queryResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/customer"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">JdbcCustomer</span><span class="o">&gt;</span> <span class="nf">findCustomersByGender</span><span class="o">(</span>
            <span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"^[MF]$"</span><span class="o">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Invalid gender"</span><span class="o">)</span> <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"genderCode"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">genderCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findByGender</span><span class="o">(</span><span class="n">genderCode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/customer"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createCustomer</span><span class="o">(</span><span class="nd">@RequestBody</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nd">@Valid</span> <span class="nc">JdbcCustomer</span> <span class="n">newCustomer</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newCustomer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PatchMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/customer/{customerId}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateCustomerFullName</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"customerId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">customerId</span><span class="o">,</span>
                                       <span class="nd">@RequestBody</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">JdbcCustomerPatchRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">updateCustomerFullName</span><span class="o">(</span><span class="n">customerId</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getNewFullName</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<h2 id="testing-1">TESTING</h2>

<ul>
  <li>Now, let’s start your service and execute api with the payload as below for api creating customer</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"fullName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Peter Parker"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"peter.parker1@marvel.com"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"birthDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000-12-31"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"M'); DROP table jdbc_merchant --"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<ul>
  <li>As you can see in the <strong>gender</strong> field we will inject the SQL script to delete the table <code class="language-plaintext highlighter-rouge">jdbc_merchant</code>. So let’s execute the api with this payload</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-execute-postman-2.PNG"><img src="/assets/images/spring-boot-sql-injection-execute-postman-2.PNG" alt="execute api with sql injection 2" title="execute api with sql injection 3" /></a></p>

<ul>
  <li>Then you can go to DB to check tables and you will see the table <code class="language-plaintext highlighter-rouge">jdbc_merchant</code> has not been deleted. why does this happen?.</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-table-deleted-2.PNG"><img src="/assets/images/spring-boot-sql-injection-table-deleted-2.PNG" alt="table is not deleted in DB 2" title="table is not deleted in DB 2" /></a></p>

<ul>
  <li>So for the first example we use the concatenated string to build the SQL statement. Let’s see the example below, the input at <code class="language-plaintext highlighter-rouge">email</code> or <code class="language-plaintext highlighter-rouge">role</code> can be a string variable or an injected SQL script.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">mytable</span> <span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> <span class="k">role</span> <span class="o">=</span> <span class="o">?</span>

<span class="c1">-- with vulnerable variable inputs, the sql will be looked like as below</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">mytable</span> 
<span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span> <span class="n">superman</span><span class="o">@</span><span class="n">jla</span><span class="p">.</span><span class="n">com</span>
<span class="k">AND</span> <span class="k">role</span> <span class="o">=</span> <span class="n">HERO</span><span class="p">;</span> <span class="k">drop</span> <span class="k">table</span> <span class="n">users</span>

</code></pre></div></div>

<ul>
  <li>When we use the Jdbc Spring Framework, It will help us to build the <code class="language-plaintext highlighter-rouge">prepared statement</code>, the vulnerable input will be put into <code class="language-plaintext highlighter-rouge">''</code> as a string value. So <code class="language-plaintext highlighter-rouge">jdbc_merchant</code> will not be deleted.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">-- with vulnerable variable inputs, they will be put into ''  as a string value</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">mytable</span> 
<span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span> <span class="s1">'superman@jla.com'</span>
<span class="k">AND</span> <span class="k">role</span> <span class="o">=</span> <span class="s1">'HERO; drop table users'</span>

<span class="c1">-- this is the query that jdbc spring generated.</span>
<span class="c1">-- you can see, it's safe from injected SQL. </span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">public</span><span class="p">.</span><span class="n">jdbc_customer</span>
<span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">full_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">'Peter Parker'</span><span class="p">,</span> <span class="s1">'peter.parker@marvel.com'</span><span class="p">,</span> <span class="s1">'2000-12-31'</span><span class="p">,</span> <span class="s1">'M</span><span class="se">''</span><span class="s1">); DROP table jdbc_merchant --'</span><span class="p">);</span>

</code></pre></div></div>

<ul>
  <li>So for now, let’s execuste the update customer api which is vulnerable by custom query, this query will call to a store procedure to update the table. After the api is executed, then you can see we received 500 internal server error</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"newFullName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Peter Parker'; drop table jdbc_merchant --"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p><a href="/assets/images/spring-boot-sql-injection-execute-postman-3.PNG"><img src="/assets/images/spring-boot-sql-injection-execute-postman-3.PNG" alt="execute api with sql injection 3" title="execute api with sql injection 3" /></a></p>

<ul>
  <li>Now, let’s check the DB again, then you can see the table <code class="language-plaintext highlighter-rouge">jdbc_merchant</code> has been deleted, when the procedure is executed to update customer fullname.</li>
</ul>

<p><a href="/assets/images/spring-boot-sql-injection-table-deleted-3.PNG"><img src="/assets/images/spring-boot-sql-injection-table-deleted-3.PNG" alt="table is deleted in DB 3" title="table is deleted in DB 3" /></a></p>


    </div><a class="u-url" href="/jekyll/update/2021/09/26/java-springboot-security-SQL-Injection.html" hidden></a>
  </article>
  
</div>


    </div>
  </div>
  <script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
  <script>addBackToTop()</script>
</body>
<footer><footer class="site-footer h-card">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <h2 class="footer-heading">StepByStep</h2>
        <div>
          <div>
            <ul>
              <li>StepByStep</li><li><a class="u-email" href="mailto:minhducnguyen189@gmail.com">minhducnguyen189@gmail.com</a></li></ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <data class="u-url" href="/%20/"></data>
        <div><ul class="social-media-list"><li><a href="https://github.com/minhducnguyen189"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">minhducnguyen189</span></a></li><li><a href="https://www.linkedin.com/in/duc-nguyen-03109b141"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">duc-nguyen-03109b141</span></a></li></ul>
</div>
      </div>
    </div>

    <div class="row">
      <p>Hi there! Let&#39;s explore some general knowleadges and briefly definitions  in programming. I hope that this website can help people saving time in learning, also give some motivations for those who have choice the developer path.</p>
    </div>
</footer></footer>
</html>